---
#
# Installing Filebeat
#

# download Filebeat 
- name: "download filebeat rpm"
  get_url: 
  args:
    url: https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-oss-7.5.0-x86_64.rpm
    dest: /tmp/filebeat-oss-7.5.0-x86_64.rpm
    force: no

 #Install filebeat"
- name: "Install filebeat rpm"
  become: true
  yum: name=/tmp/filebeat-oss-7.5.0-x86_64.rpm state=present


#Configure Filebeat yml file 

- name: Defining the default logstash output in Filebeat.yml 
  lineinfile:
   destfile: /etc/filebeat/filebeat.yml
   regexp: '#output.logstash:'
   line: 'output.logstash:'
  become: true

- name: Defining the default logstash host in Filebeat.yml 
  lineinfile:
   destfile: /etc/filebeat/filebeat.yml
   insertafter: '# The Logstash hosts'
   regexp: '  #hosts: ["localhost:5044"]'
   line: '  hosts: ["localhost:5044"]'
  become: true

- name: Defining the default paths to be crawled and fetched 
  lineinfile:
   destfile: /etc/filebeat/filebeat.yml
   insertafter: '- /var/log/*.log'
   line: '- /media/ephemeral0/logs/accumulo/*.log'
  become: true

- name: Add logging for filebeat 
  blockinfile: 
   destfile: /etc/filebeat/filebeat.yml 
   insertafter: '#logging.level: debug'
   block: |
    logging.level: info
    logging.to_files: true
    logging.files: 
      path: /var/log/filebeat
      name: filebeat
      keepfiles: 7 
      permissions: 0644
  become: true

- name: Change input configuration
  lineinfile: 
    destfile: /etc/filebeat/filebeat.yml
    regexp: 'enabled: false'
    line: 'enabled: true'
  become: true


 - 
# Starting Filebeat

- name: Starting Filebeat
  service:
   name: filebeat
   state: started
   enabled: true
  become: true

 
