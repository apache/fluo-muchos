---
#
# Installing Filebeat
#

# Install Filebeat 


- name: "download filebeat rpm"
  get_url: 
  args:
    url: https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-oss-7.5.0-x86_64.rpm
    dest: /tmp/filebeat-oss-7.5.0-x86_64.rpm
    force: no
  

 #Install filebeat"
  become: true
  yum: name=/tmp/filebeat-oss-7.5.0-x86_64.rpm state=present



#Copy filebeat modules 
- name: Copy filebeat modules
  template:
    src: "{{ filebeat_modules_sourcedir }}/{{ item }}"
    dest: /etc/filebeat/modules.d/{{ item | basename | regex_replace('\.j2','') }}
    backup: true
  with_items:
    - "{{ filebeat_modules }}"

# Starting Filebeat

- name: Starting Filebeat
  service:
   name: filebeat
   state: started
   enabled: true
  become: true

  # Download Logstash 
- name: "download logstash rpm"
  get_url: 
  args:
    url: https://artifacts.elastic.co/downloads/logstash/logstash-oss-7.5.0.rpm
    dest: /tmp/logstash-oss-7.5.0.rpm
    force: no
  

 #Install Logstash    

- name: "ensure logstash is installed"
  become: true
  yum: name=/tmp/logstash-oss-7.5.0.rpm state=present


#Make Logstash conf.d  directory 
- name: Make Logstash Conf.d Directory 
  file:
   path: /etc/logstash/conf.d/
   state: directory
  become: true

- name: Create Logstash Configuration File 
  template: 
    src: "{{ item }}.j2"
    dest: "/etc/logstash/conf.d/{{ item }}"
    owner: root
    group: root
  become: true
  with_items: 
    - elasticsearch-output.conf
    - syslog-input.conf

- name: Create Logstash filter
  template: 
    src: "{{ item }}"
    dest: "/etc/logstash/conf.d/{{item}}"
    owner: root
    group: root
  become: true
  with_items:
    - logstash.conf

# Restart Logstash

- name: Restarting logstash
  service:
   name: logstash
   state: restarted
  become: true

